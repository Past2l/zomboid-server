#!/bin/bash
set_timezone() {
  if [ $TZ ]; then
    ln -sf /usr/share/zoneinfo/$TZ /etc/localtime
  fi
}

create_directory() {
  mkdir -p $STEAM_DIRECTORY $ZOMBOID_DIRECTORY $DATA_DIRECTORY /home/steam
  ln -s $DATA_DIRECTORY /home/steam/Zomboid
}

download_steamcmd() {
  cd $STEAM_DIRECTORY
  curl -sqL "https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz" | tar zxvf -
}

download_zomboid() {
  echo -e "@ShutdownOnFailedCommand 1\n@NoPromptForPassword 1\nforce_install_dir $ZOMBOID_DIRECTORY/\nlogin anonymous\napp_update 380870 validate\nquit" >$STEAM_DIRECTORY/zomboid.txt
  $STEAM_DIRECTORY/steamcmd.sh +runscript $STEAM_DIRECTORY/zomboid.txt
  cat $ZOMBOID_DIRECTORY/ProjectZomboid64.json | jq --arg ram "-Xmx$RAM" '.vmArgs[1] |= $ram' > ./tmp.json
  mv ./tmp.json $ZOMBOID_DIRECTORY/ProjectZomboid64.json
}

create_group_user() {
  groupadd -g $GID steam
  useradd -u $UID -g $GID -m steam
  chown -R $UID:$GID /home/steam $STEAM_DIRECTORY $ZOMBOID_DIRECTORY $DATA_DIRECTORY
}

run_server() {
  sudo -u steam $ZOMBOID_DIRECTORY/start-server.sh -servername $SERVER_NAME -adminusername $ADMIN_USERNAME -adminpassword $ADMIN_PASSWORD
}

set_timezone
create_directory
download_steamcmd
download_zomboid
create_group_user
run_server